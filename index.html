<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Mealstorm</title>
  <script src="https://cdn.jsdelivr.net/npm/nosleep.js@0.12.0/dist/NoSleep.min.js"></script>
  
  <!-- Web App Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- iOS Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mealstorm">
  <meta name="format-detection" content="telephone=no">
  <meta name="theme-color" content="#2196F3">
  
  <!-- Additional PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Mealstorm">
  <meta name="msapplication-TileColor" content="#2196F3">
  <meta name="msapplication-TileImage" content="icons/mealstorm_blue_icon_144x144.png">
  
  <!-- iOS Icons -->
  <link rel="apple-touch-icon" href="icons/mealstorm_blue_icon_256x256.png">
  <link rel="apple-touch-icon" sizes="256x256" href="icons/mealstorm_blue_icon_256x256.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/mealstorm_blue_icon_512x512.png">
  <link rel="apple-touch-icon" sizes="1024x1024" href="icons/mealstorm_blue_icon_1024x1024.png">
  
  <!-- iOS Splash Screens -->
  <!-- iPhone SE, iPod Touch -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
  
  <!-- iPhone 8, 7, 6s, 6 -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
  
  <!-- iPhone X, XS -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1125x2436.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  
  <!-- iPhone XS Max -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1242x2688.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)">
  
  <!-- iPhone 16 Pro -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1179x2556.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  
  <!-- Android Phones -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1080x1920.png" media="(device-width: 360px) and (device-height: 640px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1280x1920.png" media="(device-width: 384px) and (device-height: 576px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1440x2960.png" media="(device-width: 360px) and (device-height: 740px) and (-webkit-device-pixel-ratio: 3)">
  
  <!-- iPad Mini, Air -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1536x2048.png" media="(min-device-width: 768px) and (max-device-width: 1024px)">
  
  <!-- iPad Pro 10.5" -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_1668x2224.png" media="(min-device-width: 834px) and (max-device-width: 834px)">
  
  <!-- iPad Pro 12.9" -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_2048x2732.png" media="(min-device-width: 1024px) and (max-device-width: 1024px)">
  
  <!-- Default splash screen -->
  <link rel="apple-touch-startup-image" href="splashscreen/mealstorm_splash_2048x2732.png">
  
  <!-- Add Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      line-height: 1.6;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .file-upload {
      margin: 20px 0;
      padding: 15px;
      border: 1px dashed #ccc;
      border-radius: 5px;
      text-align: center;
    }
    .hidden {
      display: none;
    }
    button {
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1976D2;
    }
    .help-button {
      background: #2196F3;
    }
    .help-button:hover {
      background: #1976D2;
    }
    .warning-button {
      background: #f44336;
    }
    .warning-button:hover {
      background: #d32f2f;
    }
    .secondary-button {
      background: #607d8b;
    }
    .secondary-button:hover {
      background: #455a64;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 700px;
      border-radius: 5px;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    pre {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
    code {
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
    }
    .saved-plans {
      margin: 15px 0;
      border-top: 1px solid #eee;
      padding-top: 15px;
    }
    .plan-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px 12px;
      margin: 8px 0;
      background-color: #f9f9f9;
    }
    .plan-title {
      font-weight: bold;
      flex-grow: 1;
    }
    .plan-actions {
      display: flex;
      gap: 5px;
    }
    .recipe-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    .recipe-tabs {
      flex: 0 0 200px;
      border-right: 1px solid #ddd;
      padding-right: 20px;
    }
    .recipe-tab {
      padding: 10px 15px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.2s;
    }
    .recipe-tab:hover {
      background-color: #e3f2fd;
      color: #2196F3;
    }
    .recipe-tab.active {
      background-color: #2196F3;
      color: white;
      font-weight: bold;
    }
    .recipe-tab.active:hover {
      background-color: #1976D2;
      color: white;
    }
    .recipe-content {
      flex: 1;
    }
    .recipe-section {
      display: none;
    }
    .recipe-section.active {
      display: block;
    }
    .steps-section {
      margin-bottom: 20px;
    }
    .recipe-title {
      margin-top: 0;
      color: #2196F3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .help-content {
      margin-top: 20px;
    }
    .help-content pre {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .help-content ul {
      list-style-type: disc;
      margin-left: 20px;
    }
    .help-content li {
      margin: 8px 0;
    }
    .checklist-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .checklist-item input[type="checkbox"] {
      margin-right: 10px;
    }
    .checklist-item label {
      display: flex;
      align-items: center;
      flex: 1;
      cursor: pointer;
    }
    .checklist-item .time {
      font-weight: bold;
      margin-right: 10px;
      min-width: 80px;
    }
    .checklist-item .task {
      flex: 1;
    }
    .checklist-item input[type="checkbox"]:checked + label {
      text-decoration: line-through;
      color: #888;
    }
    .upload-container {
      margin: 20px 0;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .upload-options {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .file-upload {
      flex: 1;
      min-width: 200px;
    }
    .json-input {
      flex: 2;
      min-width: 300px;
    }
    .json-input textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      resize: vertical;
    }
    .upload-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .upload-btn:hover {
      background: #1976D2;
    }
    input[type="file"] {
      display: none;
    }
    .main-tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .main-tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      color: #666;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .main-tab.active {
      color: #2196F3;
      border-bottom: 2px solid #2196F3;
      font-weight: bold;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .plan-section {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .plan-section h2 {
      color: #2196F3;
      margin-top: 0;
    }
    .json-format {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin: 15px 0;
    }
    .about-section {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    .about-section-content {
      margin-bottom: 40px;
    }
    .about-section h1 {
      color: #2196F3;
      margin-bottom: 30px;
    }
    .about-section h2 {
      color: #2196F3;
      margin-bottom: 15px;
    }
    .about-section p {
      line-height: 1.6;
      margin-bottom: 15px;
    }
    .about-section ol, .about-section ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }
    .about-section li {
      margin-bottom: 8px;
    }
    .about-section a {
      color: #2196F3;
      text-decoration: none;
    }
    .about-section a:hover {
      text-decoration: underline;
    }
    .cook-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .no-sleep-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .no-sleep-btn:hover {
      background: #1976D2;
    }
    .no-sleep-btn .icon {
      font-size: 16px;
    }
    .no-sleep-btn.active {
      background: #4CAF50;
    }
    .no-sleep-btn.active:hover {
      background: #45a049;
    }
    .icon {
      margin-right: 5px;
    }
    .file-upload-icon {
      font-size: 2em;
      color: #666;
      margin-bottom: 10px;
    }
  </style>
  <script>
    // Initialize NoSleep instance with error handling
    let noSleep;
    try {
      noSleep = new NoSleep();
    } catch (error) {
      console.warn('NoSleep.js not available:', error);
      // Create a dummy NoSleep object for unsupported browsers
      noSleep = {
        enable: () => Promise.resolve(),
        disable: () => {}
      };
    }
    let isNoSleepEnabled = false;
    let originalTasks = null; // Store original task times

    // Time conversion functions
    function to24Hour(timeStr) {
      if (!timeStr) return '';
      
      // Handle already 24-hour format (HH:mm)
      if (timeStr.match(/^\d{1,2}:\d{2}$/)) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
          return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }
      }
      
      // Handle 12-hour format (e.g., "4:00 PM", "4 PM", "4:00pm")
      const match = timeStr.match(/(\d{1,2}):?(\d{2})?\s*(am|pm)/i);
      if (match) {
        let [_, hours, minutes, period] = match;
        hours = parseInt(hours);
        minutes = minutes ? parseInt(minutes) : 0;
        
        if (hours < 1 || hours > 12 || minutes < 0 || minutes > 59) {
          return '';
        }
        
        if (period.toLowerCase() === 'pm' && hours !== 12) {
          hours += 12;
        } else if (period.toLowerCase() === 'am' && hours === 12) {
          hours = 0;
        }
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      }

      
      return '';
    }

    function to12Hour(timeStr) {
      if (!timeStr) return '';
      
      // Handle 12-hour format
      if (timeStr.match(/\d{1,2}:\d{2}\s*(am|pm)/i)) {
        return timeStr;
      }
      
      // Handle 24-hour format
      const [hours, minutes] = timeStr.split(':').map(Number);
      if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        return '';
      }
      
      const period = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
    }

    function timeToMinutes(timeStr) {
      if (!timeStr) return 0;
      
      const [hours, minutes] = timeStr.split(':').map(Number);
      if (isNaN(hours) || isNaN(minutes) || hours < 0 || hours > 23 || minutes < 0 || minutes > 59) {
        return 0;
      }
      
      return hours * 60 + minutes;
    }

    function minutesToTime(minutes) {
      if (typeof minutes !== 'number' || isNaN(minutes) || minutes < 0 || minutes >= 24 * 60) {
        return '';
      }
      
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }

    // Function to toggle NoSleep
    function toggleNoSleep() {
      const noSleepBtn = document.getElementById('noSleepBtn');
      if (!noSleepBtn) return;

      if (!noSleep) {
        noSleep = new NoSleep();
        noSleep.enable();
        noSleepBtn.classList.add('active');
        noSleepBtn.innerHTML = '<span class="icon">ðŸ”“</span> Screen On';
      } else {
        noSleep.disable();
        noSleep = null;
        noSleepBtn.classList.remove('active');
        noSleepBtn.innerHTML = '<span class="icon">ðŸ”’</span> Keep Screen On';
      }
    }

    // Function to show recipe section
    function showRecipeSection(sectionId) {
      // Hide all sections
      const sections = document.querySelectorAll('.recipe-section');
      sections.forEach(section => {
        section.classList.remove('active');
      });
      
      // Show selected section
      const selectedSection = document.getElementById(sectionId);
      if (selectedSection) {
        selectedSection.classList.add('active');
      }
      
      // Update tab states
      const tabs = document.querySelectorAll('.recipe-tab');
      tabs.forEach(tab => {
        tab.classList.remove('active');
        if (tab.getAttribute('data-section') === sectionId) {
          tab.classList.add('active');
        }
      });
    }

    // Function to process the JSON data
    function processData(data, savePlan = true) {
      if (!data || !data.tasks) {
        console.error('Invalid data format');
        return;
      }

      // Update title
      const titleElement = document.getElementById('title');
      if (titleElement) {
        titleElement.textContent = data.title || 'Mealstorm';
      }
      
      originalTasks = [...data.tasks]; // Store original tasks
      
      // Set the target time input to the last task's time
      const timeInput = document.getElementById('target-time');
      if (timeInput && data.tasks.length > 0) {
        const lastTask = data.tasks[data.tasks.length - 1];
        if (lastTask && lastTask.time) {
          const time24 = to24Hour(lastTask.time);
          if (time24) {
            timeInput.value = time24;
          }
        }
      }
      
      // Create tabs container
      const tabsContainer = document.querySelector('.recipe-tabs');
      tabsContainer.innerHTML = '<div class="recipe-tab active" data-section="steps-section" onclick="showRecipeSection(\'steps-section\')">Timeline Steps</div>';
      
      // Create content container
      const contentContainer = document.querySelector('.recipe-content');
      contentContainer.innerHTML = `
        <div id="steps-section" class="recipe-section active">
          <div class="time-shift-container">
            <label for="target-time">Target Time:</label>
            <input type="time" id="target-time" step="60">
            <button onclick="shiftTimes()">Adjust Timeline</button>
          </div>
          <div id="checklist"></div>
        </div>
      `;
      
      // Get the checklist element after creating the content
      const list = document.getElementById('checklist');
      if (!list) {
        console.error('Checklist element not found');
        return;
      }
      
      list.innerHTML = ''; // Clear previous content
      
      // Process tasks and create recipe tabs
      data.tasks.forEach((task, index) => {
        // Add task to checklist
        const item = document.createElement('div');
        item.className = 'checklist-item';
        item.innerHTML = `
          <input type="checkbox" id="task${index}" onchange="updateTaskStatus(${index})">
          <label for="task${index}">
            <span class="time">${task.time}</span>
            <span class="task">${task.text || task.task}</span>
          </label>
        `;
        list.appendChild(item);
      });

      // Add recipe tabs and sections
      if (data.recipes) {
        data.recipes.forEach((recipe, index) => {
          const tabId = `recipe-${index}`;
          
          // Add recipe tab
          const tab = document.createElement('div');
          tab.className = 'recipe-tab';
          tab.textContent = recipe.name;
          tab.setAttribute('data-section', tabId);
          tab.onclick = () => showRecipeSection(tabId);
          tabsContainer.appendChild(tab);
          
          // Add recipe section
          const section = document.createElement('div');
          section.id = tabId;
          section.className = 'recipe-section';
          section.innerHTML = `
            <h3>${recipe.name}</h3>
            <div class="recipe-ingredients">
              <h4>Ingredients:</h4>
              <ul>
                ${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}
              </ul>
            </div>
            <div class="recipe-steps">
              <h4>Steps:</h4>
              <ol>
                ${recipe.instructions.map(step => `<li>${step}</li>`).join('')}
              </ol>
            </div>
          `;
          contentContainer.appendChild(section);
        });
      }
      
      // Save to localStorage if requested
      if (savePlan) {
        localStorage.setItem('currentMealPlan', JSON.stringify(data));
        // Also save to saved timelines
        saveTimelineToStorage(data);
        // Update the saved plans list
        updateSavedPlansList();
      }
    }

    // Function to shift times based on new target time
    function shiftTimes() {
      const timeInput = document.getElementById('target-time');
      if (!timeInput || !timeInput.value || !originalTasks) return;
      
      const newTargetTime = timeInput.value;
      const newTargetMinutes = timeToMinutes(newTargetTime);
      const originalTargetTime = originalTasks[originalTasks.length - 1].time;
      const originalTargetMinutes = timeToMinutes(to24Hour(originalTargetTime));
      const timeDiff = newTargetMinutes - originalTargetMinutes;
      
      // Update checklist times
      const checklist = document.getElementById('checklist');
      if (checklist) {
        const items = checklist.getElementsByClassName('checklist-item');
        originalTasks.forEach((task, index) => {
          if (index < items.length) {
            const timeSpan = items[index].querySelector('.time');
            if (timeSpan) {
              const newTime = minutesToTime(timeToMinutes(to24Hour(task.time)) + timeDiff);
              timeSpan.textContent = to12Hour(newTime);
            }
          }
        });
      }
    }

    // Function to save timeline to localStorage
    function saveTimelineToStorage(data) {
      // Get the existing saved timelines
      const savedTimelines = JSON.parse(localStorage.getItem('savedTimelines')) || {};
      
      // Create a unique key using the title and timestamp
      const timelineKey = `timeline_${Date.now()}`;
      
      // Add the new timeline
      savedTimelines[timelineKey] = {
        title: data.title,
        data: data,
        timestamp: Date.now()
      };
      
      // Save back to localStorage
      localStorage.setItem('savedTimelines', JSON.stringify(savedTimelines));
      
      // Update the saved plans list in the UI
      updateSavedPlansList();
    }
    
    // Function to update the list of saved plans in the UI
    function updateSavedPlansList() {
      const savedTimelines = JSON.parse(localStorage.getItem('savedTimelines')) || {};
      const savedPlansContainer = document.getElementById('saved-plans-container');
      
      if (!savedPlansContainer) return;
      
      // Clear existing content
      savedPlansContainer.innerHTML = '';
      
      if (Object.keys(savedTimelines).length === 0) {
        savedPlansContainer.innerHTML = '<p>No saved meal plans yet.</p>';
        return;
      }
      
      // Sort by most recent first
      const sortedKeys = Object.keys(savedTimelines).sort((a, b) => 
        savedTimelines[b].timestamp - savedTimelines[a].timestamp
      );
      
      // Create UI for each saved plan
      sortedKeys.forEach(key => {
        const plan = savedTimelines[key];
        const planElement = document.createElement('div');
        planElement.className = 'plan-item';
        planElement.innerHTML = `
          <div class="plan-title">${plan.title}</div>
          <div class="plan-actions">
            <button onclick="loadSavedPlan('${key}')">Load</button>
            <button onclick="editSavedPlan('${key}')" class="secondary-button">Edit</button>
            <button onclick="deleteSavedPlan('${key}')" class="warning-button">Delete</button>
          </div>
        `;
        savedPlansContainer.appendChild(planElement);
      });
    }

    // Function to load a saved plan
    function loadSavedPlan(key) {
      const savedTimelines = JSON.parse(localStorage.getItem('savedTimelines')) || {};
      const plan = savedTimelines[key];
      if (plan && plan.data) {
        processData(plan.data);
        switchTab('cook');
      }
    }

    // Function to edit a saved plan
    function editSavedPlan(key) {
      const savedTimelines = JSON.parse(localStorage.getItem('savedTimelines')) || {};
      const plan = savedTimelines[key];
      if (plan && plan.data) {
        // Switch to plan tab
        switchTab('plan');
        // Load the JSON into the textarea
        const jsonInput = document.getElementById('jsonInput');
        if (jsonInput) {
          jsonInput.value = JSON.stringify(plan.data, null, 2);
          // Scroll the textarea into view
          jsonInput.scrollIntoView({ behavior: 'smooth' });
        }
      }
    }

    // Function to delete a saved plan
    function deleteSavedPlan(key) {
      if (confirm('Are you sure you want to delete this saved plan?')) {
        const savedTimelines = JSON.parse(localStorage.getItem('savedTimelines')) || {};
        delete savedTimelines[key];
        localStorage.setItem('savedTimelines', JSON.stringify(savedTimelines));
        updateSavedPlansList();
      }
    }

    // Function to show help modal
    function showHelp() {
      const modal = document.getElementById('helpModal');
      if (modal) {
        modal.style.display = 'block';
      }
    }

    // Function to initialize event listeners
    function initializeEventListeners() {
      // Help button
      const helpBtn = document.getElementById('helpBtn');
      if (helpBtn) {
        helpBtn.addEventListener('click', showHelp);
      }

      // Close modal when clicking the X
      const closeBtn = document.querySelector('.close');
      if (closeBtn) {
        closeBtn.addEventListener('click', () => {
          const modal = document.getElementById('helpModal');
          if (modal) {
            modal.style.display = 'none';
          }
        });
      }

      // Close modal when clicking outside
      window.addEventListener('click', (event) => {
        const modal = document.getElementById('helpModal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });

      // Load default button
      const loadDefaultBtn = document.getElementById('load-default');
      if (loadDefaultBtn) {
        loadDefaultBtn.addEventListener('click', () => {
          const defaultData = {
            title: "Default Dinner Plan",
            tasks: [
              {
                time: "4:00 PM",
                task: "Start preheating oven to 350Â°F",
                recipe: {
                  name: "Roast Chicken",
                  ingredients: [
                    "1 whole chicken (4-5 lbs)",
                    "2 Tbsp olive oil",
                    "2 tsp kosher salt",
                    "1 tsp black pepper",
                    "3 cloves garlic, crushed",
                    "1 lemon, quartered"
                  ],
                  steps: [
                    "Preheat oven to 350Â°F",
                    "Rub chicken with olive oil, salt, and pepper",
                    "Place garlic and lemon inside cavity",
                    "Roast for 1 hour 15 minutes, until internal temperature reaches 165Â°F",
                    "Let rest for 15 minutes before carving"
                  ]
                }
              },
              {
                time: "4:15 PM",
                task: "Prepare vegetables",
                recipe: {
                  name: "Roasted Vegetables",
                  ingredients: [
                    "2 lbs mixed vegetables (potatoes, carrots, onions)",
                    "2 Tbsp olive oil",
                    "1 tsp salt",
                    "1/2 tsp black pepper",
                    "2 sprigs fresh rosemary"
                  ],
                  steps: [
                    "Cut vegetables into similar-sized pieces",
                    "Toss with olive oil, salt, and pepper",
                    "Add rosemary sprigs",
                    "Roast for 45 minutes, stirring occasionally"
                  ]
                }
              },
              {
                time: "5:30 PM",
                task: "Check chicken temperature and let rest"
              },
              {
                time: "5:45 PM",
                task: "Carve chicken and serve with vegetables"
              }
            ]
          };
          processData(defaultData);
        });
      }

      // Clear data button
      const clearDataBtn = document.getElementById('clear-all-data');
      if (clearDataBtn) {
        clearDataBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to clear all saved data?')) {
            localStorage.clear();
            location.reload();
          }
        });
      }

      // File input
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
      }
    }

    // Function to handle file selection
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            processData(data);
          } catch (error) {
            alert('Error parsing JSON file. Please check the format.');
            console.error('JSON parse error:', error);
          }
        };
        reader.readAsText(file);
      }
    }

    // Function to handle JSON input
    function handleJsonInput() {
      const jsonInput = document.getElementById('jsonInput');
      if (!jsonInput || !jsonInput.value) return;

      
      try {
        const data = JSON.parse(jsonInput.value);
        processData(data);
        // Clear the textarea after successful load
        jsonInput.value = '';
      } catch (error) {
        alert('Error parsing JSON. Please check the format.');
        console.error('JSON parse error:', error);
      }
    }

    // Initialize event listeners when the DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initializeEventListeners();
      updateSavedPlansList();
      
      // Load saved meal plan if it exists
      const savedPlan = localStorage.getItem('currentMealPlan');
      if (savedPlan) {
        try {
          const data = JSON.parse(savedPlan);
          processData(data, false);
        } catch (error) {
          console.error('Error loading saved plan:', error);
        }
      }
    });

    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Deactivate all tabs
      document.querySelectorAll('.main-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      // Activate selected tab
      document.querySelector(`.main-tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    }
  </script>
</head>
<body>
  <div class="main-tabs">
    <button class="main-tab active" onclick="switchTab('about')">About</button>
    <button class="main-tab" onclick="switchTab('plan')">Plan</button>
    <button class="main-tab" onclick="switchTab('cook')">Cook</button>
  </div>

  <div id="about-tab" class="tab-content active">
    <div class="about-section">
      <h1>Welcome to Mealstorm!</h1>
      
      <div class="about-section-content">
        <h2>What is Mealstorm?</h2>
        <p>Mealstorm is a cooking companion that helps you organize and execute multi-recipe meals. It breaks down complex cooking tasks into a clear timeline, making it easier to coordinate multiple dishes and serve everything at the perfect time.</p>
      </div>

      <div class="about-section-content">
        <h2>Getting Started</h2>
        <ol>
          <li>Head to the <strong>Plan</strong> tab to create your meal plan</li>
          <li>You can either:
            <ul>
              <li>Upload a JSON file with your meal plan</li>
              <li>Paste your meal plan JSON directly</li>
              <li>Use our <a href="https://chatgpt.com/g/g-682cdfd61f0c8191ad1c063a4c46efef-mealstorm-buddy" target="_blank">Mealstorm Buddy</a> to generate a meal plan</li>
            </ul>
          </li>
          <li>Switch to the <strong>Cook</strong> tab to see your interactive cooking timeline</li>
        </ol>
      </div>

      <div class="about-section-content">
        <h2>Need Help Creating a Plan?</h2>
        <p>Try our <a href="https://chatgpt.com/g/g-682cdfd61f0c8191ad1c063a4c46efef-mealstorm-buddy" target="_blank">Mealstorm Buddy</a> - a custom ChatGPT assistant that helps you create meal plans in the correct format!</p>
      </div>

      <div class="about-section-content">
        <h2>JSON Format Guide</h2>
        <p>Your meal plan should follow this structure:</p>
        <div class="json-format">
          <pre><code>{

  "title": "Your Meal Plan Title",
  "tasks": [
    { "time": "4:30pm", "text": "Preheat oven to 450Â°F" },
    { "time": "4:45pm", "text": "Toss and roast potatoes" }
  ],
  "recipes": [
    {
      "name": "Recipe Name",
      "ingredients": [
        "2 Tbsp olive oil",
        "1 cup diced onion",
        "2 cloves garlic"
      ],
      "instructions": [
        "Step 1: Heat oil in pan",
        "Step 2: Add onions and cook until soft",
        "Step 3: Add garlic and cook 30 seconds"
      ]
    }
  ]
}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <div id="plan-tab" class="tab-content">
    <div class="plan-section">
      <h2>Create a New Meal Plan</h2>
      <p>Upload a JSON file or paste your meal plan. Need help with the format? Check the <strong>About</strong> tab for details.</p>
      
      <div class="upload-container">
        <div class="upload-options">
          <div class="file-upload">
            <input type="file" id="fileInput" accept=".json" onchange="handleFileSelect(event)" style="display: none;">
            <button onclick="document.getElementById('fileInput').click()" class="upload-btn">Upload JSON File</button>
          </div>
          <div class="paste-upload">
            <textarea id="jsonInput" placeholder="Paste your JSON here..." rows="10" style="width: 100%;"></textarea>
            <button onclick="handleJsonInput()">Load Plan</button>
          </div>
        </div>
      </div>
    </div>

    <div class="saved-plans">
      <h2>Saved Plans</h2>
      <div id="saved-plans-container"></div>
    </div>
  </div>

  <div id="cook-tab" class="tab-content">
    <div class="cook-header">
      <h1 id="title">Mealstorm</h1>
      <button id="noSleepBtn" class="no-sleep-btn" onclick="toggleNoSleep()">
        <span class="icon">ðŸ”’</span> Keep Screen On
      </button>
    </div>
    <div id="recipe-container" class="recipe-container">
      <div class="recipe-tabs" id="recipe-tabs"></div>
      <div class="recipe-content" id="recipe-content"></div>
    </div>
  </div>
</body>
</html>